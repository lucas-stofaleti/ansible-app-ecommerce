---
- name: Configure MariaDB
  hosts: all
  become: yes

  tasks:
    - name: Install and ensure MariaDB in latest version
      ansible.builtin.apt:
        name: mariadb-server
        state: latest
        update_cache: yes

    - name: Start & Enable service MariaDB
      ansible.builtin.service:
        name: mariadb
        state: started
        enabled: yes

    - name: Install pip3
      ansible.builtin.apt:
        name: python3-pip
        state: latest
        update_cache: yes

    - name: Make sure pymysql is present
      pip:
        name: pymysql
        state: present

    - name: Create new databases ecomdb
      community.mysql.mysql_db:
        name:
          - ecomdb
        state: present
        login_unix_socket: /run/mysqld/mysqld.sock

    - name: Create database user with name 'ecomuser' with all database privileges
      community.mysql.mysql_user:
        name: ecomuser
        password: "{ { db_password } }"
        priv: "*.*:ALL"
        state: present
        login_unix_socket: /run/mysqld/mysqld.sock

    - name: Copy sql script to server
      copy:
        src: db-load-script.sql
        dest: /tmp/db-load-script.sql
      register: copy_sql

    - name: Insert sample data into database
      mysql_db:
        name: ecomdb
        state: import
        target: /tmp/db-load-script.sql
        login_unix_socket: /run/mysqld/mysqld.sock
      when: copy_sql.changed

- name: Configure Web App
  hosts: all
  become: yes

  tasks:
    - name: Install and ensure Apache, PHP in latest version
      ansible.builtin.apt:
        name:
          - apache2
          - php
          - php-mysql
        state: latest
        update_cache: yes

    - name: Start & Enable service Apache
      ansible.builtin.service:
        name: apache2
        state: started
        enabled: yes
